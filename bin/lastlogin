#!/usr/bin/env bash

#
# Fetch the last login times on the current system from the unified
# log of macOS.
#
# usage: lastlogin [<options>]
#
lastlogin() {
  local date="today"
  local format="%Y-%m-%d %H:%M";
  local limit=20;

  while (( $# > 0 )); do
    case "$1" in
      -[0-9])      limit="${1:1}"       ;;
      -f|--format) format="$2";   shift ;;
      -s|--start)  date="$2";     shift ;;
      -n)          limit="$2";    shift ;;
    esac
    shift;
  done

  case "${date}" in
    "today")      date="$(date +"%Y-%m-%d")" ;;
    "yesterday")  date="$(date -v-1d +"%Y-%m-%d")" ;;
    "last week")  date="$(date -v-1w +"%Y-%m-%d")" ;;
  esac

  sudo log show --style json --predicate '(subsystem == "com.apple.loginwindow.logging") && (eventMessage beginswith "-[LWDefaultScreenLockUI authSuccess]") && (eventMessage endswith "password is CORRECT")' --start "${date}" \
    | jq --raw-output 'reverse | .[] | .timestamp |= capture("^(?<date>\\d{4}-\\d{2}-\\d{2}) (?<time>\\d{2}:\\d{2}:\\d{2})(\\.\\d{6})?(?<timezone>\\+\\d{4})$", "") | .timestamp = "\(.timestamp.date) \(.timestamp.time)\(.timestamp.timezone)" | .timestamp |= strptime("%Y-%m-%d %H:%M:%S%z") | .timestamp |= strftime("'"${format}"'") | .timestamp' \
    | head -n "${limit}"
}

lastlogin "$@"
