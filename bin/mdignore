#!/usr/bin/env bash

#
# Return the canonical path of the specified filename, eliminating any symbolic
# links encountered in the path
#
# usage: realpath <path>
#
realpath() {
  python -c "import os,sys; print os.path.realpath(*(sys.argv[1:]))" "$@"
}

#
# Recursively find all folders with a given name and exclude them from the
# spotlight index. Requires reindexing.
#
# usage: mdignore [<name>]
#
mdignore() {
  # Parse command options.
  local depth=25
  local dir="."

  while true; do
    case "$1" in
      -d | --depth ) depth=$2; shift 2 ;;
      -p | --path )  dir="$2"; shift 2 ;;
      -- )           shift; break ;;
      * )            break ;;
    esac
  done

  # Return early if directory names are missing.
  (( $# > 0 )) || return 1

  # Collect the directory names to search for.
  local needles=()

  for needle in "$@"; do
    if (( ${#needles[@]} == 0 )); then
      needles+=( -name "${needle}" )
    else
      needles+=( -or -name "${needle}" )
    fi
  done

  # Search for the given directories and add the noindex file.
  find "$(realpath "${dir}")" \
    \( \
      -path "*/.*" \
      -or -path "*node_modules/*" \
      -or -path "*bower_components/*" \
      -or -path "${HOME}/Applications*" \
      -or -path "${HOME}/Desktop" \
      -or -path "${HOME}/Downloads" \
      -or -path "${HOME}/Library*" \
      -or -path "${HOME}/Movies*" \
      -or -path "${HOME}/Music*" \
      -or -path "${HOME}/Pictures*" \
      -or -path "${HOME}/Public*" \
    \) \
    -prune -or \
    -type d \
    -maxdepth "${depth}" \
    \( \
      "${needles[@]}" \
    \) \
    -print \
    -exec touch "{}/.metadata_never_index" \;
}

mdignore "$@"
