#!/usr/bin/env bash

#
# How to use the script.
#
# usage: usage
#
usage() {
  echo "usage: mount_encfs <source> <target>" >&2
  exit 1
}

#
# Test if rsync is available in the users $PATH.
#
# usage: is_encfs_available
#
is_encfs_available() {
  command -v encfs >/dev/null 2>&1
}

#
# Test if a drive is already mounted.
#
# usage: is_encfs_mounted
#
is_encfs_mounted() {
  mount | grep encfs >/dev/null 2>&1
}

#
# Write an error message.
#
# usage: error <message>
#
error() {
  echo "\033[0;31m==> $*\033[0;m" >&2
}

#
# Write an error message and stop script execution.
#
# usage: die <message>
#
die() {
  error "$*"
  exit 1
}

#
# Script entry point
#
# $1 = Source directory
# $2 = Mount point
#
main() {
  local source="$1"
  local target="$2"

  if [[ -z "$source" || -z "$target" ]]; then
    usage
  fi

  if ! is_encfs_available; then
    die "mount_encfs: encfs not found"
  fi

  if is_encfs_mounted; then
    die "mount_encfs: Another drive is already mounted"
  fi

  if [ ! -d "$source" ]; then
    die "mount_encfs: Source directory not found: $source"
  fi

  if [ ! -d "$target" ]; then
    mkdir -p "$target"
    chmod 0700 "$target"
  fi

  local volume_name
  volume_name=$(basename "$target")

  # Mount the encfs volume
  # -o volname=<str>      set the file system's volume name
  # -o allow_root         allow access to root
  # -o local              mark the volume as "local" (default is "nonlocal")
  # -o hard_remove        immediate removal (don't hide files)
  # -o auto_xattr         handle extended attributes entirely through ._ files
  # -o nolocalcaches      meta option equivalent to noreadahead,noubc,novncache
  /usr/local/bin/encfs -S "$source" "$target" --extpass="/usr/bin/security find-generic-password -gl encfs 2>&1 >/dev/null|grep password|/usr/bin/cut -d'\"' -f 2" -o volname="$volume_name"

  if [ $? -ne 0 ]; then
    die "mount_encfs: An error occured while mounting the volume: $volume_name."
  fi

  return 0
}

main "$@"
